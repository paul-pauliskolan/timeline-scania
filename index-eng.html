<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>History of Scania (Skåne)</title>
    <link rel="stylesheet" href="styles.css">

</head>

<body>
    <h1>History of Scania (Skåne)</h1>
    <div class="flag-container">
        <a href="index.html"> <img src="swedish-flag.png" alt="Swedish Flag" class="flag-icon"></a>
        <a href="index-eng.html"><img src="british-flag.png" alt="British Flag" class="flag-icon"></a>
    </div>
    <svg></svg>

    <div id="tooltip"
        style="position: absolute; opacity: 0; background-color: lightgray; padding: 5px; border-radius: 3px; pointer-events: none;">
    </div>

    <div id="info-box">
        <span class="close-btn">X</span>
        <p>
            <strong>Zoom:</strong> Use your mouse scroll wheel or touchpad to zoom in and out on the timeline. This
            allows you to see
            more details or get an overview of the entire timeline.
        </p>
        <p><strong>Drag:</strong> Click and hold the left mouse button, then move the mouse to drag the timeline left or
            right. This
            helps you navigate through different periods of history.</p>
        <p><strong>Hover:</strong> When you move your mouse over a bar or point on the timeline, a tooltip will appear.
        </p>
        <p><strong>Click: </strong>Click on a point or a rectangle to get more info</p>


    </div>
    <div id="open-icon">☰ Show instructions</div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
        // JavaScript to handle the opening and closing of the info box
        const infoBox = document.getElementById('info-box');
        const openIcon = document.getElementById('open-icon');
        const closeBtn = document.querySelector('#info-box .close-btn');

        openIcon.addEventListener('click', () => {
            infoBox.style.display = 'block';
            openIcon.style.display = 'none';
        });

        closeBtn.addEventListener('click', () => {
            infoBox.style.display = 'none';
            openIcon.style.display = 'block';

        });

        let events = [];

        fetch('events-eng.json')
            .then(response => response.json())
            .then(data => {
                events = data;
                console.log(events);
                // You can now use the `events` variable in your code
                initializeD3();
            })
            .catch(error => console.error('Error loading events:', error));
        function initializeD3() {
            const svg = d3.select("svg"),
                margin = { top: 30, right: 120, bottom: 30, left: 20 };

            let width = window.innerWidth;
            let height = window.innerHeight;

            svg.attr("viewBox", `0 0 ${width} ${height}`)
                .attr("preserveAspectRatio", "xMidYMid meet");

            let x = d3.scaleLinear()
                .domain([-15000, 2024])
                .range([margin.left, width - margin.right]);

            let xAxis = d3.axisBottom(x)
                .tickFormat(d => d < 0 ? Math.abs(d) + " BCE" : d + " CE");

            let gX = svg.append("g")
                .attr("class", "axis")
                .attr("transform", `translate(0, ${height - margin.bottom})`)
                .call(xAxis);

            const getVerticalPosition = (index, total) => {
                return height - margin.bottom - (index * (height - margin.top - margin.bottom + 590) / total) - 20;
            };

            // Add vertical lines every 1000 years
            const verticalLines = d3.range(-15000, 2024, 1000);
            svg.selectAll(".vertical-line")
                .data(verticalLines)
                .enter().append("line")
                .attr("class", "vertical-line")
                .attr("x1", d => x(d))
                .attr("x2", d => x(d))
                .attr("y1", margin.top)
                .attr("y2", height - margin.bottom)
                .attr("stroke", "lightgray")
                .attr("stroke-width", 1);

            let rangesGroup = svg.selectAll(".range")
                .data(events.filter(d => d.end))
                .enter().append("rect")
                .attr("class", "range")
                .attr("x", d => x(d.start))
                .attr("width", d => x(d.end) - x(d.start))
                .attr("y", (d, i) => getVerticalPosition(i, events.length))
                .attr("height", 20)
                .attr("fill", d => d.timestamp === "period" ? "rgba(167, 215, 55, 0.6)" : "rgba(167, 215, 255, 0.6)");

            let eventsGroup = svg.selectAll(".event")
                .data(events.filter(d => d.end))
                .enter().append("text")
                .attr("class", "event")
                .attr("x", d => d.end ? x((d.start + d.end) / 2) : x(d.start))
                .attr("y", (d, i) => getVerticalPosition(i, events.length) + 10)
                .attr("dy", ".35em")
                .attr("text-anchor", "middle")
                .text(d => d.content);

            let pointEventsGroup = svg.selectAll(".point-event")
                .data(events.filter(d => !d.end))
                .enter().append("circle")
                .attr("class", "point-event")
                .attr("cx", d => x(d.start))
                .attr("cy", (d, i) => getVerticalPosition(i, events.length) - 35)
                .attr("r", 5)
                .attr("fill", "blue");

            let pointLabelsGroup = svg.selectAll(".point-label")
                .data(events.filter(d => !d.end))
                .enter().append("text")
                .attr("class", "event")
                .attr("x", d => x(d.start))
                .attr("y", (d, i) => getVerticalPosition(i, events.length) - 25)
                .attr("dy", ".35em")
                .attr("text-anchor", "middle")
                .text(d => d.content);

            // Tooltip setup
            const tooltip = d3.select("#tooltip");

            // Add tooltips for range events
            rangesGroup.on("mouseover", function (event, d) {
                tooltip.transition().duration(200).style("opacity", 1);
                tooltip.html(`${d.content}<br>${Math.abs(d.start)} ${d.start < 0 ? 'BCE' : 'CE'} - ${Math.abs(d.end)} ${d.end < 0 ? 'BCE' : 'CE'}<br>${d.desc ? d.desc : ''}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 30) + "px");
            })
                .on("mousemove", function (event) {
                    tooltip.style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 30) + "px");
                })
                .on("mouseout", function () {
                    tooltip.transition().duration(200).style("opacity", 0);
                });

            // Add tooltips for point events
            pointEventsGroup.on("mouseover", function (event, d) {
                tooltip.transition().duration(200).style("opacity", 1);
                tooltip.html(`${d.content}<br>${Math.abs(d.start)} ${d.start < 0 ? 'BCE' : 'CE'}<br>${d.desc ? d.desc : ''}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 30) + "px");
            })
                .on("mousemove", function (event) {
                    tooltip.style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 30) + "px");
                })
                .on("mouseout", function () {
                    tooltip.transition().duration(200).style("opacity", 0);
                });

            // Zoom and pan functionality
            const zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on("zoom", zoomed);

            svg.call(zoom);

            function zoomed(event) {
                const transform = event.transform;
                gX.call(xAxis.scale(transform.rescaleX(x)));
                rangesGroup.attr("x", d => transform.applyX(x(d.start)))
                    .attr("width", d => transform.applyX(x(d.end)) - transform.applyX(x(d.start)));
                pointEventsGroup.attr("cx", d => transform.applyX(x(d.start)));
                eventsGroup.attr("x", d => transform.applyX(x((d.start + d.end) / 2)));
                pointLabelsGroup.attr("x", d => transform.applyX(x(d.start)));
                svg.selectAll(".vertical-line")
                    .attr("x1", d => transform.applyX(x(d)))
                    .attr("x2", d => transform.applyX(x(d)));
            }

            // Handle window resize
            window.addEventListener('resize', () => {
                width = window.innerWidth;
                height = window.innerHeight;

                svg.attr("viewBox", `0 0 ${width} ${height}`);

                x.range([margin.left, width - margin.right]);

                gX.attr("transform", `translate(0, ${height - margin.bottom})`)
                    .call(xAxis);

                rangesGroup.attr("x", d => x(d.start))
                    .attr("width", d => x(d.end) - x(d.start))
                    .attr("y", (d, i) => getVerticalPosition(i, events.length));

                eventsGroup.attr("x", d => d.end ? x((d.start + d.end) / 2) : x(d.start))
                    .attr("y", (d, i) => getVerticalPosition(i, events.length) + 10);

                pointEventsGroup.attr("cx", d => x(d.start))
                    .attr("cy", (d, i) => getVerticalPosition(i, events.length) - 35);

                pointLabelsGroup.attr("x", d => x(d.start))
                    .attr("y", (d, i) => getVerticalPosition(i, events.length) - 20);

                svg.selectAll(".vertical-line")
                    .attr("x1", d => x(d))
                    .attr("x2", d => x(d))
                    .attr("y1", margin.top)
                    .attr("y2", height - margin.bottom);
            });
        }
    </script>
</body>

</html>